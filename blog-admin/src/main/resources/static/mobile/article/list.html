<!DOCTYPE html>
<html>
<head>
<title>文章列表</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/toastr.min.css" rel="stylesheet">
<link href="/static/css/font-awesome.min.css" rel="stylesheet">
<link href="/static/css/animate.css" rel="stylesheet">
<link href="/static/css/style.css" rel="stylesheet">
<style>
	input[type="checkbox"]{ display: inline-block; width: 20px; height: 20px; margin: 0; vertical-align: middle;}
</style>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>
<body style="padding: 20px;">

<form id="searchForm" class="form-inline" onsubmit="search.query();return false;">
	<div class="form-group">
		<div class="input-group">
			<span class="input-group-btn">
				<a href="add.html" target="_blank" class="btn btn-sm btn-primary btn-block"><i class="fa fa-plus"></i> 新增</a>
			</span>
			<span class="input-group-btn">
				<select name="type_id" class="form-control input-sm" style="padding: 3px 5px;width: auto;">
					<option value="">文章分类</option>
					<option v-for="typeInfo in typeList" :value="typeInfo.type_id">{{ typeInfo.type }}</option>
				</select>
			</span>
			<input type="text" name="title" class="form-control input-sm" placeholder="输入文章标题关键字进行搜索" />
			<span class="input-group-btn">
				<button type="submit" class="btn btn-sm btn-info" ><i class="fa fa-search"></i> 搜索</button>
			</span>
		</div>
	</div>
</form>

<table id="search-result" class="table table-hover table-condensed table-striped">
	<thead>
		<tr>
			<th style="width: 50px;">#</th>
			<th>标题</th>
		</tr>
	</thead>
	<tbody>
		<template v-if="articleList.length > 0">
			<tr v-for="articleInfo in articleList" >
				<td><input type="checkbox" name="article_id" :value="articleInfo.article_id"></td>
				<td v-on:click="window.open('update.html#' + articleInfo.article_id, '_blank')">{{ articleInfo.title }}</td>
			</tr>
		</template>
		<template v-else="">
			<tr>
				<td colspan="2">空</td>
			</tr>
		</template>
	</tbody>
</table>

<div class="form-group">
	<button class="btn btn-sm btn-danger" onclick="remove()"><i class="fa fa-remove"></i> 删除</button>
</div>
<div class="form-group">
	<button class="btn btn-default btn-block" onclick="search.nextPage()">加载更多</button>
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/plugins/layer/layer.min.js"></script>
<!--右上角提示框插件-->
<script src="/static/js/toastr.min.js"></script>
<script src="/static/js/common.js"></script>
<script type="text/javascript">
	var vueDom = new Vue({
		el: '#search-result',
		data: {
			articleList: [],
		},
	});
	
	var search;
	(function() {
		ajax('get', '/article/init', null, function(res) {
			new Vue({
				el: '#searchForm',
				data: {
					typeList: res,
				},
			});
			
			search = new Search();
			search.query();
		});
	})();
	
	function Search() {
		var offset = 0;
		var limit = 4;
		var total = 0;
		
//		//搜索条件回显
//		(function() {
//			var queryParams = sessionStorage.getItem(window.location.pathname +'queryParams');
//			if(queryParams) {
//				queryParams = JSON.parse(queryParams);
//				console.log(queryParams)
//				formload(document.getElementById('searchForm'), queryParams.search);
//				offset = queryParams.offset;
//				limit = queryParams.limit;
//				total = queryParams.total;
//			}
//		})();
		
		this.query = function() {
			offset = 0;
			total = 0;
			vueDom.articleList = [];
			getData();
		}
		
		this.nextPage = function() {
			if((offset+limit) >= total) {
				(typeof toastr == 'undefined') ? alert('已到达最后一页') : toastr['warning']('已到达最后一页');
				return;
			}
			offset += limit;
			getData();
		}
		
		function getData() {
			var data = {
				search: getFormObj(document.getElementById('searchForm')),
				offset: offset,
				limit: limit,
			}
			ajax('get', '/article/getList', data, function(res) {
				total = res.total;
				res.rows.forEach(function(row) {
					vueDom.articleList.push(row);
				});
//				//保存搜索条件
//				sessionStorage.setItem(window.location.pathname +'queryParams', JSON.stringify(data));
			});
		}
	}
	
	function remove() {
		var data = getFormObj(document.getElementById('search-result'));
		if(data.article_id == '') {
			return;
		}
		layer.confirm('确定要删除吗？', function(index) {
			layer.close(index);
			var article_ids = data.article_id.split(',');
			article_ids.forEach(function(article_id) {
				ajax('post', '/article/delete', {
					article_id: article_id,
				}, function(res) {
					search.query();
				})
			});
		});
	}
</script>
</body>
</html>
