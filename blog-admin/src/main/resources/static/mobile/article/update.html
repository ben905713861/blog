<!DOCTYPE html>
<html>
<head>
<title>文章修改</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/toastr.min.css" rel="stylesheet">
<link href="/static/css/font-awesome.min.css" rel="stylesheet">
<link href="/static/css/animate.css" rel="stylesheet">
<link href="/static/css/style.css" rel="stylesheet">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>
<body>

<form onsubmit="update(this);return false;">
	<div class="row" style="padding: 10px 0 5px;">
		<div class="col-xs-4">
			<div style="padding-left: 10px;">
				<button type="button" class="btn btn-sm btn-default" onclick="windowClose(false)"><i class="fa fa-reply"></i> 返回</button>
			</div>
		</div>
		<div class="col-xs-4">
			<h3 class="text-center">修改文章</h3>
		</div>
		<div class="col-xs-4">
			<div style="padding-right: 10px;text-align: right;">
				<button type="submit" class="btn btn-sm btn-primary"><i class="fa fa-edit"></i> 修改</button>
			</div>
		</div>
	</div>
	<table class="table table-condensed table-bordered" style="table-layout:fixed;margin-bottom: 0;">
		<tr>
			<th style="width: 100px;">*分类：</th>
			<td>
				<select name="type_id" class="form-control input-sm" style="padding: 3px 12px;">
					<option v-for="typeInfo in typeList" :value="typeInfo.type_id">{{ typeInfo.type }}</option>
				</select>
			</td>
		</tr>
		<tr>
			<th>*附件标题：</th>
			<td><input type="text" pattern=".{1,50}" title="50字符以内" required="" class="form-control" name="title" /></td>
		</tr>
		<tr>
			<th>关键词：</th>
			<td><input type="text" pattern=".{1,100}" title="100字符以内" class="form-control" name="key_words" /></td>
		</tr>
		<tr>
			<th>描述：</th>
			<td>
				<textarea name="description" class="form-control" maxlength="255" placeholder="为空时自动拾取内容正文的前255个字符填充"></textarea>
			</td>
		</tr>
		<tr>
			<th>缩略图：</th>
			<td>
				<a onclick="uploadThumb(this)">
					<img name="thumb_url" style="max-height: 100px;" src="img/upload-thumb.png" title="点我上传" />
					<input type="text" class="hidden" name="thumb_path" />
				</a>
			</td>
		</tr>
		<tr>
			<th>*是否推荐：</th>
			<td>
				<label><input type="radio" name="is_recommend" value="1" />是 </label>
				<label><input type="radio" name="is_recommend" value="0" checked="" />否 </label>
			</td>
		</tr>
	</table>
	<script id="editor" name="content" type="text/plain" style="width:100%;"></script>
</form>


<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/plugins/layer/layer.min.js"></script>
<!--右上角提示框插件-->
<script src="/static/js/toastr.min.js"></script>
<!--ueditor编辑器-->
<script src="/static/js/plugins/ueditor/ueditor.config.js"></script>
<script src="/static/js/plugins/ueditor/ueditor.all.min.js"></script>
<script src="/static/js/common.js"></script>
<script type="text/javascript">
	var article_id = window.location.hash.split('#')[1];
	
	window.UEDITOR_CONFIG.serverUrl = '/ueditor/index?type=article';//type决定上传到哪个目录
	var editor = UE.getEditor('editor', {
		toolbars: [[
            'bold', 'insertimage', 'insertvideo', 'attachment',
        ]]
	});
	
	(function() {
		var vueDom = new Vue({
			el: 'select[name="type_id"]',
			data: {
				typeList: [],
			},
		});
		ajax('get', '/article/init', null, function(res) {
			vueDom.typeList = res;
			load();
		});
	})();
	
	function load() {
		ajax('get', '/article/getOne', {
			article_id: article_id
		}, function(res) {
			if(!res.thumb_path) {
				res.thumb_url = '/static/img/upload-thumb.png';
			}
			formload(document.querySelector('body>form'), res);
			setTimeout(function() {
				editor.setContent(res.content);
			}, 200);
		});
	}
	
	function uploadThumb(btn) {
		input_upload('img', false, function(file) {
			ajax('file', '/article/uploadThumb', {
				articleThumb: file,
			}, function(res) {
				formload(btn, res);
			});
		});
	}
	
	function update(form) {
		if(!editor.hasContents()) {
			layer.alert('正文不得为空');
			return;
		}
		var submitBtn = form.querySelector('[type="submit"]');
		submitBtn.disabled = true;
		
		var data = getFormObj(form);
		data.article_id = article_id;
		ajax('post', '/article/update', data, function(res) {
			windowClose(true);
		}, null, function end() {
			submitBtn.disabled = false;
		});
	}
	
	function windowClose(action) {
		if(parent) {
			if(action) {
				parent.toastr['success']('操作成功');
				parent.search.query();
			}
			parent.iframeClose();
		}
	}
</script>
</body>
</html>
